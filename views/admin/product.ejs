<%- include('./layouts/header.ejs') %>

<div class="container-fluid page-body-wrapper">
  <!-- partial:partials/_navbar.html -->
  <%- include('./layouts/nav.ejs') %>
  <!-- partial -->
  <div class="main-panel">
    <div class="content-wrapper">

      <div class="row">
        <div class="col-12 grid-margin">
          <div class="card">
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <input type="text" class="form-control" id="searchInput" placeholder="Search by Users Name" oninput="searchUsers()">
                </div>
              </div>
              <div class="table-responsive">
                <table class="order-details">
                  <thead>
                      <tr>
                          <th>Order Date</th>
                          <th>Total</th>
                          <th>Product</th>
                          <th>Name</th>
                          <th>Price</th>
                          <th>Quantity</th>
                          <th>Total</th>
                          <th>Action</th>
                      </tr>
                  </thead>
                  <tbody>
                      <% orders.forEach(order => { %>
                          <tr>
                              <td rowspan="<%= order.Products.length %>"><%= new Date(order.date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }) %></td>
      
      
                              <td rowspan="<%= order.Products.length %>"><%= order.total %></td>
                              <% order.Products.forEach((product, index) => { %>
                                  <% if (index !== 0) { %>
                                      <tr>
                                  <% } %>
                                  <td>
                                      <a href="/productdetails?id=<%=product.products._id%>">
                                          <img src="<%= product.products.pictures[0].replace('public', '') %>" alt="<%= product.name %>" style="height:20vh">
                                      </a>
                                  </td>
                                  <td><%= product.name %></td>
                                  <td><%= product.price %></td>
                                  <td><%= product.quantity %></td>
                                  <td><%= product.total %></td>
                                  <td>
                                      <% if (['placed', 'shipped'].includes(product.orderStatus)) { %>
                                          <!-- Cancel button for placed or shipped products -->
                                          <button onclick="cancelOrder('<%= order._id %>', '<%= product._id %>')" style="margin-bottom: 5px;">Cancel</button>
                                      <% } else if (['out for delivery', 'delivered'].includes(product.orderStatus)) { %>
                                          <!-- Return button for out for delivery or delivered products -->
                                          <button onclick="returnOrder('<%= order._id %>', '<%= product._id %>')" style="margin-bottom: 5px;">Return</button>
                                      <% } else if (['request return', 'request cancellation'].includes(product.orderStatus)) { %>
                                          <!-- Display the order status itself as the button -->
                                          <button disabled style="margin-bottom: 5px;"><%= product.orderStatus %></button>
                                      <% } %>
                                  </td>
                                  <% if (index !== 0) { %>
                                      </tr>
                                  <% } %>
                              <% }); %>
                          </tr>
                      <% }); %>
                  </tbody>
              </table>
      
              </div>
              
              

            </div>
          </div>
        </div>
      </div>

    </div>
    <!-- content-wrapper ends -->

    

    <!-- partial:partials/_footer.html -->
    <footer class="footer">
      <div class="d-sm-flex justify-content-center justify-content-sm-between">
        <span class="text-muted d-block text-center text-sm-left d-sm-inline-block">Aura beauty</span>
      </div>
    </footer>
    <!-- partial -->
  </div>
  <!-- main-panel ends -->
</div>
<!-- page-body-wrapper ends -->


<script>
  function showConfirmationModal(action, productId) {
    $('#actionText').text(action);
    $('#confirmationModal').modal('show');

    // Set up the confirm button click event
    $('#confirmActionBtn').off('click').on('click', function () {
      // Perform the action based on the confirmation
      switch (action.toLowerCase()) {
        case 'edit':
          // Redirect to delete route
          window.location.href = `/admin/products/edit?id=${productId}`;
          break;
        case 'delete':
          // Redirect to delete route
          window.location.href = `/admin/products/delete?id=${productId}`;
          break;
        case 'toggle':
          // Redirect to toggle route
          window.location.href = `/admin/products/toggle?id=${productId}`;
          break;
        // Add more cases for other actions if needed
        default:
          console.error(`Unknown action: ${action}`);
      }

      // Hide the modal after confirming
      $('#confirmationModal').modal('hide');
    });
  }

  
  function searchUsers() {
    // Get the search query from the input field
    const searchQuery = document.getElementById('searchInput').value.toLowerCase();

    // Get all table rows in the tbody
    const rows = document.querySelectorAll('tbody tr');

    // Loop through each row and hide/show based on the first letter of the user's name
    rows.forEach(row => {
      // Extract the user's name from the row (adjust the index based on your table structure)
      const userName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();

      // Check if the first letter of the user's name matches the search query
      if (userName.startsWith(searchQuery)) {
        // If the first letter matches, display the row
        row.style.display = '';
      } else {
        // If the first letter does not match, hide the row
        row.style.display = 'none';
      }
    });
  }   

</script>

<%- include('./layouts/footer.ejs') %>
